{% extends "base_user.html" %}

{% block title %}التقاط إشعار جديد{% endblock %}

{% block content %}
<div class="card p-4 shadow-sm text-center">
    <h3 class="mb-4">التقاط إشعار جديد</h3>

    <video id="video" width="100%" autoplay playsinline style="border:1px solid #ccc; border-radius:5px;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div class="mt-3 d-flex flex-column gap-2">
        <button id="captureBtn" class="btn btn-save-op">التقاط الإشعار</button>
        <button id="retakeBtn" class="btn btn-danger" style="display:none;">إعادة التقاط</button>
    </div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');

// تشغيل الكاميرا
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => { video.srcObject = stream; })
    .catch(err => { alert("تعذر الوصول للكاميرا: " + err); });

captureBtn.addEventListener('click', () => {
    // أخذ لقطة
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    // تحويل الصورة لبيانات Base64
    const dataUrl = canvas.toDataURL('image/png');

    // إرسال الصورة لـ FastAPI
    fetch('/upload_capture', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'captured_image=' + encodeURIComponent(dataUrl)
    }).then(() => {
        window.location.href = "/view";
    });

    // إخفاء زر الالتقاط وإظهار إعادة الالتقاط
    captureBtn.style.display = 'none';
    retakeBtn.style.display = 'block';
});

retakeBtn.addEventListener('click', () => {
    captureBtn.style.display = 'block';
    retakeBtn.style.display = 'none';
});
</script>

<style>
.btn-save-op {
    background-color: #a1bf37;
    border-color: #a1bf37;
    color: #fff;
}
.btn-save-op:hover { background-color: #8c9b2f; }

.btn-danger {
    background-color: #d9534f;
    border-color: #d43f3a;
    color: #fff;
}
.btn-danger:hover { background-color: #c12e2a; }
</style>
{% endblock %}
