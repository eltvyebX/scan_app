{% extends "base_user.html" %}
{% block title %}التقاط الإشعار{% endblock %}

{% block content %}
<div class="card p-3 text-center">

    <h4 class="mb-3">التقاط صورة الإشعار</h4>

    <video id="camera" autoplay playsinline style="width:100%; border-radius:10px;"></video>

    <!-- زر التقاط -->
    <button id="captureBtn" class="btn btn-primary w-100 mt-3">
        التقاط الصورة
    </button>

    <!-- الفورم الذي يرسل الصورة -->
    <form id="captureForm" method="POST" action="/upload_capture">
        <input type="hidden" name="captured_image" id="captured_image">
    </form>

    <hr class="my-3">

    <!-- زر الذهاب لصفحة view -->
    <a href="/view" class="btn btn-secondary w-100">عرض الإشعارات</a>
</div>

<canvas id="canvas" style="display:none;"></canvas>

{% endblock %}

{% block scripts %}
<script>
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const hiddenInput = document.getElementById("captured_image");
    const form = document.getElementById("captureForm");

    // تشغيل الكاميرا
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => video.srcObject = stream)
        .catch(err => alert("لا يمكن تشغيل الكاميرا: " + err));

    // التقاط الصورة
    captureBtn.addEventListener("click", () => {
        const w = video.videoWidth;
        const h = video.videoHeight;

        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, w, h);

        // تحويل الصورة base64
        const dataURL = canvas.toDataURL("image/png");

        // وضعها في input
        hiddenInput.value = dataURL;

        // إرسال الفورم
        form.submit();
    });
</script>
{% endblock %}
