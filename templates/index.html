{% extends "base_user.html" %}

{% block title %}التقاط إشعار جديد{% endblock %}

{% block content %}
<div class="card p-3 shadow-sm text-center" style="max-width: 500px; margin: auto;">
    <h3 class="mb-3">التقاط إشعار جديد</h3>

    <!-- Video from camera -->
    <div class="video-container" style="position: relative; width: 100%; padding-top: 75%;">
        <video id="video" autoplay playsinline style="position: absolute; top:0; left:0; width:100%; height:100%; border-radius:8px;"></video>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>

    <div class="mt-3 d-grid gap-2">
        <button id="captureBtn" class="btn btn-save-op btn-lg">التقاط الصورة</button>
    </div>

    <form id="uploadForm" action="/upload_capture" method="post" enctype="multipart/form-data" style="display:none; margin-top: 15px;">
        <input type="hidden" name="captured_image" id="captured_image">
        <button type="submit" class="btn btn-save-op btn-lg">حفظ الصورة</button>
    </form>
</div>

<style>
.btn-save-op {
    background-color: #a1bf37;
    border-color: #a1bf37;
    color: #fff;
    font-size: 1.1rem;
    padding: 0.75rem 0;
    border-radius: 6px;
}
.btn-save-op:hover, .btn-save-op:focus {
    background-color: #8c9b2f;
    border-color: #8c9b2f;
    color: #fff;
}

.video-container {
    border: 2px solid #a1bf37;
    border-radius: 8px;
    overflow: hidden;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .card {
        padding: 15px;
    }
    .btn-save-op {
        font-size: 1rem;
        padding: 0.65rem 0;
    }
}
</style>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const captureBtn = document.getElementById('captureBtn');
const uploadForm = document.getElementById('uploadForm');
const capturedImageInput = document.getElementById('captured_image');

// الوصول للكاميرا
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(stream => {
    video.srcObject = stream;
})
.catch(err => {
    alert("لا يمكن الوصول للكاميرا: " + err);
});

// عند الضغط على زر الالتقاط
captureBtn.addEventListener('click', () => {
    const context = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    // تحويل الصورة إلى Base64 لإرسالها عبر الفورم
    const dataURL = canvas.toDataURL('image/png');
    capturedImageInput.value = dataURL;

    // إظهار زر الحفظ
    uploadForm.style.display = 'block';
});
</script>
{% endblock %}
