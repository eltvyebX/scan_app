{% extends "base.html" %}
{% block content %}
<div class="card p-3 text-center">

    <h3 class="mb-3">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h3>
    <p class="text-muted">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø«Ù… Ø§Ø¶ØºØ· Ø§Ù„ØªÙ‚Ø·</p>

    <video id="camera" autoplay playsinline class="w-100 rounded border"></video>

    <canvas id="snapshot" class="d-none"></canvas>

    <button onclick="takePhoto()" class="btn btn-primary w-100 mt-3">
        ðŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
    </button>

    <form id="scanForm" action="/scan" method="post" enctype="multipart/form-data">
        <input type="file" id="photoInput" name="file" class="d-none">
    </form>
</div>

<script>
    // --- ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ---
    const video = document.getElementById("camera");

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }})
        .then(stream => { video.srcObject = stream; })
        .catch(err => alert("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err));

    // --- Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© ---
    function takePhoto() {
        const canvas = document.getElementById("snapshot");
        const context = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        context.drawImage(video, 0, 0);

        canvas.toBlob(blob => {
            const file = new File([blob], "captured.jpg", { type: "image/jpeg" });

            // ØªØ¹Ø¨Ø¦Ø© input type=file ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            document.getElementById("photoInput").files = dataTransfer.files;

            document.getElementById("scanForm").submit();
        }, "image/jpeg");
    }
</script>

{% endblock %}
